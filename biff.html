<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <title>A simple Javascript Biff on IPFS</title>
    <link rel="stylesheet" href="style.css">

    <script src="js/sha256.js"></script>
    <script src="js/essential.js"></script>
    <script src="js/ipfs.js"></script>
    <script src="js/functions.js"></script>
    </head>

    <body>


<h2> 1-bit transmission</h2>


<h3>Problem: </h3>
<p> A sender wants to transmit one bit (called "biff-bit") to a friend's inbox
to notify him he has some new message (<i>"You've got mail"</i>)

<br>
friends: 
<select name="category" id="cat">
  <option label="group">
    <option value="">Family</option>
    <option value="">Friends</option>
    <option value="">Work</option>
    <option value="">Acquintance</option>
    <option value="">Trusted</option>
    <option value="">Alphabetic</option>
  </option>
</select>
<select name="nickname" id="nick">
  <option label="nickname">
</select>

<h4>Purpose:</h4>
This is to architect a system based primary on "pull services", and minimise "push services"
as push service are very sensitive to spam / corruption, whereas pull is locally controlled
and is a good fit for P2P system.

<h3>Solution: </h3>

<ol>
<li> Recipient creates a <a href="#" name=uniq>unique</a> content to trigger an inbox notification.
<br>
The existance of this content on IPFS will means the biff-bit is set (true) otherwise it is false.
note: only false to true transition are possible ( one-way boolean event flag )
<li>
The recipient prepares a "<a href="#" name=recipe>recipe</a>" for anyone to create the same content,
<br><textarea name=recipetext disabled rows=5 cols=80>
</textarea>
<br>Therefore, any sender can replicate and post the content to set the biff-bit

<li>
 The sender get the recipe and create the exact same content (content's hash: <span id=trigger_hash>n/a</span>)
<li> Sender post it on IPFS
by pressing the
<button id=notify onclick="notify(event)">notify</button> button.

<li> The recipient can "pull" the 1-bit biff by checking it the IPFS file exists at the address : <a href="#" name='qm'>/ipfs/:qm</a>

<p> if the content does exist then the biff bit is set to true !
<br><span id=content></span>
<button id=pin onclick="pin(event)" style="display:none">pin</button>
<button id=log onclick="log(event)" style="display:none">log</button>
<span id=logfile style="display:none"><a id=loglink href="uri:michelc:/my/biff.log">/my/biff.log</a></span>
<p>EOT (\x04)

<li> Once recipient has read message he can optionally send an message acknowledge (ACK) back
such that the sender can removed it from his outbox;
no biff-bit acknowledge is necessary they have a time-to-live (TTL = 3 days)
</ol>
<!--
 Q: can we have a proof that biff-bit = false at a give time... ?
 Q: can we have a notify message solely creatable by sender ? (pre-build signature)
-->

<h3>Status</h3>
<b><span>current biff-bit = <span id=biff-bit>false</span></b>


<script>
 const sharedsecret = '123-secret-de-polichinelle;'; // to be fetched from keybase or end-to-end encrypted system
 const today = getTic(); // get_date();
 let inbox_name = 'michelc'; // reciever
 let inbox_peerkey = 'QmcfHufAK9ErQ9ZKJF7YX68KntYYBJngkGDoVKcZEJyRve'
 var uniq_content;
 var sha1;
 var qm_trigger;
 var peerid; // sender
 var gw_port = '8080';

async function main () {
 peerid = await Promise.resolve(promisedPeerId);

 // create content
 let message = `biff-bit for ${inbox_name} is true on ${today}, this message is intended for peerid ${inbox_peerkey}`;
 uniq_content = getNid(sharedsecret + message);

 // create trigger hash
 qm_trigger = await ipfsGetHashByContent(uniq_content); // without publication !
 document.getElementsByName('qm')[0].href = `http://127.0.0.1:${gw_port}/ipfs/${qm_trigger}`
 if (typeof(qm_tmpl) == 'undefined') {
  qm_tmpl = document.getElementsByName('qm')[0].innerHTML;
 }
 document.getElementsByName('qm')[0].innerHTML = qm_tmpl.replace(':qm',qm_trigger);
 document.getElementsByName('qm')[0].href = `http://127.0.0.1:${gw_port}/ipfs/${qm_trigger}`

 // build recipe
 sha1 = await ipfsPostSHA1ByContent(uniq_content)
 document.getElementsByName('uniq')[0].href = `http://127.0.0.1:${gw_port}/ipfs/${sha1}`
 document.getElementsByName('uniq')[0].title = message
 let recipe = `to notify ${inbox_name} run the following command\n` +
              `ipfs cat ${sha1} | ipfs add -\n`
 document.getElementsByName('recipetext')[0].innerHTML = recipe

 // publish recipe
 let recipe_hash = await ipfsPostHashByContent(recipe);
 let tics = getTic();
 let file_path = '/public/notification-recipe.txt'
 let hrecord = recipe_hash+': ["'+ file_path +'",'+ tics +']'
 let hhash = await ipfsLogAppend(core['history'],hrecord)

 // sender get recipe ...
 // ...

 // pull status 
 let biff = await getBiffStatus(qm_trigger);

}

main();

async function notify(ev) {
  // TODO: get recipe extract sha1 (could be replaced by a js function to compute the sha1)...
  let content = await ipfsGetContentByHash(sha1);
  let qm = await ipfsPostHashByContent(content);
  document.getElementById('trigger_hash').innerHTML = qm
  return qm
}

async function getBiffStatus(qm) {
  var status = false;
  let [callee, caller] = functionNameJS();
  let content = await ipfsGetContentByHash(qm)
  .then( buf => {
        document.getElementById('content').innerHTML = buf;
        document.getElementById('biff-bit').innerHTML = 'true' 
        document.getElementById('log').style.display = ''; // '' to display it w/o 'blocking' i.e. it removes the display attribute !
        document.getElementById('pin').style.display = ''; // to display it !
        status = true;
        return buf;
        })
  .catch( _ => { console.log('no new message'); return undefined; });
  return status;
}

async function pin(ev) {
 let [callee, caller] = functionNameJS();
 let obj = await ipfsPinAdd(qm_trigger)
 let pinned_hash = obj.Pins[0];
 console.log(callee+'.obj:',obj);
 let buf = document.getElementById('content').innerHTML;
 document.getElementById('content').innerHTML = `<a href=http://127.0.0.1:${gw_port}/ipfs/${pinned_hash}>${buf}</a>`;
 document.getElementById('pin').innerHTML = 'pinned';
}

async function log(ev) {
 let [callee, caller] = functionNameJS();
 let biff_record = `${today}: ${uniq_content} ${qm_trigger}`
 let log_hash = await ipfsLogAppend('/my/biff.log',biff_record)
 document.getElementById('log').innerHTML = 'logged';
 document.getElementById('log').style.display = ''; // to display it w/o 'blocking'

 document.getElementById('loglink').href = `http://127.0.0.1:${gw_port}/ipfs/${log_hash}`
 document.getElementById('loglink').innerHTML = '/my/biff.log';
 document.getElementById('logfile').style.display = '';

}
</script>


