<!DOCTYPE html>

<head>
    <script src="js/sha256.js"></script>
    <script src="js/js-yaml.js" type=text/javascript></script>
    <script src="js/essential.js"></script>
    <script src="js/ipfs.js"></script>
    <script src="js/functions.js"></script>
</head>

<div>
<p><span id=node>Recipient</span>'s peerid: <span class=peerid>MyPeerID</span>
<br><input name=fullname value="Michel Combes" placeholder="your fullname">
<br><button onclick="get_biff_status(event)">check inbox</button>
<br><span id=token></span>
<br>status: <span id=biff>biff=false</span>

<br><button onclick="get_mail(event)">get mail</button>
<div id=inbox></div>


<script>
  var peerid;
  var biff = false
  initialize();

async function get_biff_status(ev){
    let [callee, caller] = functionNameJS(); // logInfo("message !")
  let fullname = document.getElementsByName('fullname')[0].value; 
  // let fullname = ev.target.value
  console.debug(callee+'.fullname:',fullname);
  let biff = await get_notification_status(fullname,peerid);
  document.getElementById('biff').innerHTML = 'biff='+biff;
  if (biff == true) {
    alert("You've got Mail !");
    // get_mail();
  } else {
    console.log("You have no Mail");
  }
}

async function get_mail(ev) {
let [callee, caller] = functionNameJS(); // logInfo("message !")

for (let i in Object.keys(friendsmap)) {
    let key = Object.keys(friendsmap)[i];
    let friend = friendsmap[key];
    console.log(callee+'.friend.nickname:',friend.nickname);
    if (friend.nickname != 'francoisc') { continue; }
    console.debug(callee+'.friend',friend);
    let peerkey = friend.peerkey;
    let mboxid = getNid('urn:message:to:'+peerid+':from:'+peerkey);
    let mbox_path = '/my/outbox/'+mboxid+'.json'
    let indexlogf = indexlogfilename(mbox_path);
    console.debug(callee+'.indexlogf:',indexlogf);
    let ipath = indexlogf.substr(indexlogf.indexOf('/',2));
    let index = await ipfsGetContentByPath('/ipns/'+peerkey+ipath);
    console.debug(callee+'.index:',index);
    
}

}

</script>
